<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Trace</title>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #000;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        .trace-output {
            white-space: pre-line;
            font-size: 14px;
        }
        .loading {
            color: #ffff00;
        }
        .noscript {
            color: #ff6666;
        }
    </style>
</head>
<body>
    <!-- 為 curl 和無 JavaScript 環境提供基本信息 -->
    <noscript>
        <div class="noscript">
# Cloudflare 連接測試站點 - Trace 端點
# 此頁面需要 JavaScript 來收集完整的連接信息
# 
# 為了獲得完整的連接測試結果，請在瀏覽器中訪問：
# https://zhuyuan.tw/
#
# 或者使用以下 curl 命令獲取 Cloudflare 原生 trace：
# curl https://zhuyuan.tw/cdn-cgi/trace
#
# 本站點提供以下測試功能：
# - IPv4/IPv6 連通性檢測
# - Cloudflare 服務節點測試 
# - IPv6 連通性評分
# - ASN 和 ISP 資訊查詢
# - WARP 狀態檢測
        </div>
    </noscript>

    <div id="traceOutput" class="trace-output loading">正在收集連接信息...</div>

    <script>
        // Cloudflare 測試端點 - 從主網站複製
        const testEndpointsByPlan = {
            free: [{ name: 'Thisisch', url: 'thisisch.net/cdn-cgi/trace' }],
            pro: [
                { name: 'CDNJS', url: 'cdnjs.com/cdn-cgi/trace' },
                { name: 'JSDelivr', url: 'jsdelivr.com/cdn-cgi/trace' },
                { name: 'Node.js', url: 'nodejs.org/cdn-cgi/trace' }
            ],
            business: [
                { name: 'NAF Store', url: 'nafstore.net/cdn-cgi/trace' },
                { name: 'Trevor Project', url: 'thetrevorproject.org/cdn-cgi/trace' },
                { name: 'Vote America', url: 'voteamerica.com/cdn-cgi/trace' },
                { name: 'Waver Host', url: 'waverhost.com/cdn-cgi/trace' }
            ],
            enterprise: [
                { name: 'Discord', url: 'discordapp.com/cdn-cgi/trace' },
                { name: 'Polestar', url: 'polestar.com/cdn-cgi/trace' },
                { name: 'Cloudflare', url: 'www.cloudflare.com/cdn-cgi/trace' },
                { name: 'NCR', url: 'www.ncr.com/cdn-cgi/trace' }
            ]
        };

        async function getASNInfo(ip) {
            try {
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                if (response.ok) {
                    const data = await response.json();
                    return {
                        asn: `${data.asn || 'Unknown'}`,
                        org: data.org || data.isp || 'Unknown',
                        country: data.country_code || 'Unknown'
                    };
                }
            } catch (error) {
                console.log('ASN查詢失敗:', error);
            }
            return { asn: 'Unknown', org: 'Unknown', country: 'Unknown' };
        }

        async function testIPv6Connectivity() {
            const tests = {
                available: false,
                connection: false,
                dns: false
            };
            
            try {
                const ipv6Response = await fetch('https://[2606:4700:4700::1111]/cdn-cgi/trace', {
                    cache: 'no-cache'
                });
                if (ipv6Response.ok) {
                    tests.available = true;
                    tests.connection = true;
                }
            } catch (error) {
                console.log('IPv6連接測試失敗:', error);
            }
            
            try {
                const dnsResponse = await fetch('https://cloudflare-dns.com/dns-query?name=ipv6.google.com&type=AAAA', {
                    headers: { 'Accept': 'application/dns-json' }
                });
                if (dnsResponse.ok) {
                    const dnsData = await dnsResponse.json();
                    if (dnsData.Answer && dnsData.Answer.length > 0) {
                        tests.dns = true;
                    }
                }
            } catch (error) {
                console.log('IPv6 DNS測試失敗:', error);
            }
            
            let score = 0;
            if (tests.available) score += 40;
            if (tests.connection) score += 40;
            if (tests.dns) score += 20;
            
            return { tests, score };
        }

        async function testEndpoint(endpoint) {
            const testUrl = `https://${endpoint.url}`;
            
            try {
                const startTime = performance.now();
                const response = await fetch(testUrl, {
                    cache: 'no-cache',
                    mode: 'cors'
                });
                const endTime = performance.now();
                
                if (response.ok) {
                    const latency = Math.round(endTime - startTime);
                    const text = await response.text();
                    
                    const data = {};
                    text.split('\n').forEach(line => {
                        const [key, value] = line.split('=');
                        if (key && value) {
                            data[key] = value;
                        }
                    });
                    
                    return { 
                        latency, 
                        colo: data.colo || '-',
                        status: 'success'
                    };
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                return { 
                    latency: null, 
                    colo: '-', 
                    status: 'error'
                };
            }
        }

        async function collectFullTraceInfo() {
            const output = [];
            const startTime = Date.now();
            
            try {
                output.push('=== Cloudflare 連接測試站點 - 詳細報告 ===\n');
                
                // 獲取基本連接信息
                const [ipv4Response, ipv6Response] = await Promise.allSettled([
                    fetch('https://1.1.1.1/cdn-cgi/trace').then(r => r.text()),
                    fetch('https://[2606:4700:4700::1111]/cdn-cgi/trace').then(r => r.text()).catch(() => null)
                ]);
                
                let mainData = {};
                let ipv4 = null, ipv6 = null;
                
                if (ipv4Response.status === 'fulfilled') {
                    ipv4Response.value.split('\n').forEach(line => {
                        const [key, value] = line.split('=');
                        if (key && value) {
                            mainData[key] = value;
                            if (key === 'ip') ipv4 = value;
                        }
                    });
                }
                
                if (ipv6Response.status === 'fulfilled' && ipv6Response.value) {
                    ipv6Response.value.split('\n').forEach(line => {
                        const [key, value] = line.split('=');
                        if (key === 'ip' && value) {
                            ipv6 = value;
                        }
                    });
                }

                // 連接信息區塊
                output.push('[連接信息]');
                output.push(`IPv4 地址: ${ipv4 || '未檢測到'}`);
                output.push(`IPv6 地址: ${ipv6 || '未檢測到'}`);
                output.push(`連接節點: ${mainData.colo || '未知'}`);
                output.push(`位置: ${mainData.loc || '未知'}`);
                output.push(`WARP 狀態: ${mainData.warp === 'on' ? '啟用' : '關閉'}`);
                output.push(`TLS 版本: ${mainData.tls || '未知'}`);
                output.push(`HTTP 版本: ${mainData.http || '未知'}`);

                // 獲取 ASN 信息
                const primaryIP = ipv6 || ipv4;
                if (primaryIP) {
                    const asnInfo = await getASNInfo(primaryIP);
                    output.push(`ASN: AS${asnInfo.asn}`);
                    output.push(`ISP: ${asnInfo.org}`);
                    output.push(`國家: ${asnInfo.country}`);
                }

                output.push('');

                // IPv6 連通性測試
                output.push('[IPv6 連通性評估]');
                const ipv6Test = await testIPv6Connectivity();
                output.push(`總分: ${ipv6Test.score}/100`);
                output.push(`IPv6 可用性: ${ipv6Test.tests.available ? '支援' : '不支援'}`);
                output.push(`IPv6 連接: ${ipv6Test.tests.connection ? '正常' : '失敗'}`);
                output.push(`DNS 解析: ${ipv6Test.tests.dns ? '正常' : '失敗'}`);
                
                output.push('');

                // 服務測試
                output.push('[Cloudflare 服務測試]');
                
                for (const [plan, endpoints] of Object.entries(testEndpointsByPlan)) {
                    output.push(`\n${plan.toUpperCase()} Plan:`);
                    
                    for (const endpoint of endpoints) {
                        const result = await testEndpoint(endpoint);
                        if (result.status === 'success') {
                            output.push(`  ${endpoint.name}: ${result.latency}ms (${result.colo})`);
                        } else {
                            output.push(`  ${endpoint.name}: 測試失敗`);
                        }
                    }
                }

                output.push('');
                output.push(`[測試統計]`);
                output.push(`測試時間: ${new Date().toISOString()}`);
                output.push(`收集耗時: ${Date.now() - startTime}ms`);
                output.push(`用戶代理: ${navigator.userAgent}`);
                output.push(`測試端點: ${window.location.href}`);
                
                return output.join('\n');
                
            } catch (error) {
                console.error('收集 trace 信息失敗:', error);
                return `錯誤: 無法收集完整的連接信息\n時間: ${new Date().toISOString()}\n錯誤訊息: ${error.message}`;
            }
        }
        
        // 初始化
        async function init() {
            const outputElement = document.getElementById('traceOutput');
            outputElement.textContent = '正在收集連接信息，請稍候...';
            
            try {
                const traceInfo = await collectFullTraceInfo();
                outputElement.textContent = traceInfo;
            } catch (error) {
                outputElement.textContent = `錯誤: ${error.message}`;
            }
        }
        
        // 等待頁面加載完成
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>